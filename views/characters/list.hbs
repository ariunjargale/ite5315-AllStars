<div class="list-container">
  <div class="character-page-actions">
    <h1>{{title}}</h1>
    {{#if session.userId}}
      <a href="/characters/create" class="character-btn-create">+ New Character</a>
    {{/if}}
  </div>

  <form action="/characters" method="GET" class="advanced-filter-box">
    <div class="character-filter-grid">
      <div class="filter-item">
        <label>Name</label>
        <input
          type="text"
          name="name"
          value="{{query.name}}"
          placeholder="Search by name..."
        />
      </div>

      <div class="filter-item">
        <label>Species</label>
        <input
          type="text"
          name="species"
          value="{{query.species}}"
          placeholder="Human, Alien..."
        />
      </div>

      <div class="filter-item">
        <label>Last Known Location</label>
        <input
          type="text"
          name="location"
          value="{{query.location}}"
          placeholder="Earth, Citadel..."
        />
      </div>

      <div class="filter-item">
        <label>Origin</label>
        <input
          type="text"
          name="origin"
          value="{{query.origin}}"
          placeholder="Origin name..."
        />
      </div>
      <div class="filter-item">
        <label>Status</label>
        <select name="status">
          <option value="">All Statuses</option>
          <option value="alive" {{isSelected query.status "alive"}}>Alive</option>
          <option value="dead" {{isSelected query.status "dead"}}>Dead</option>
        </select>
      </div>
      <div class="filter-item">
        <label>Gender</label>
        <select name="gender">
          <option value="">All Genders</option>
          <option value="Female" {{isSelected query.gender "Female"}}>Female</option>
          <option value="Male" {{isSelected query.gender "Male"}}>Male</option>
          <option value="Genderless" {{isSelected query.gender "Genderless"}}>Genderless</option>
          <option value="unknown" {{isSelected query.gender "unknown"}}>unknown</option>
        </select>
      </div>
    </div>

    <div class="filter-actions">
      <button type="submit" class="character-filter-apply-btn">Apply Filters</button>
      <a href="/characters" class="character-filter-clear-btn">Clear</a>
    </div>
  </form>

  <div class="list-stats">
    <p>Total Characters: <strong>{{totalCount}}</strong></p>
  </div>

  {{#if characters.length}}
    <div class="list">
      {{#each characters}}
        <div class="list-card" data-character-id="{{this.characterId}}">
          <div class="card-image-wrapper">
            <img src="{{this.image}}" alt="{{this.name}}" class="card-image" />
          </div>

          <div class="list-header">
            <h2>{{this.name}}</h2>
            <span class="list-code {{#if this.isAlive}}status-alive{{else}}status-dead{{/if}}">
              {{#if this.isAlive}}Alive{{else}}Dead{{/if}}
            </span>
          </div>

          <div class="list-details">
            <p><strong>Species:</strong> {{this.species}}</p>
            <p><strong>Gender:</strong> {{this.gender}}</p>
            <p><strong>Location:</strong> {{this.location.name}}</p>
          </div>

          <div class="list-actions">
            <!-- VIEW PROFILE ALWAYS VISIBLE -->
            <a href="/characters/{{this.characterId}}" class="btn-view">View Profile</a>
            
            <!-- CRUD ACTIONS - HIDDEN BY DEFAULT -->
            {{#if ../session.userId}}
              <div class="crud-actions" style="display: none;">
                <a href="/characters/edit/{{this.characterId}}" class="btn-edit">Edit</a>
                <form 
                  action="/characters/delete/{{this.characterId}}" 
                  method="POST" 
                  onsubmit="return confirm('Are you sure you want to delete this character?')"
                  style="display: inline-block;"
                >
                  <button type="submit" class="btn-delete">Delete</button>
                </form>
              </div>
            {{/if}}
          </div>
        </div>
      {{/each}}
    </div>

    <div class="pagination-container">
      {{#if (gt currentPage 1)}}
        <a
          href="/characters?page=1&name={{query.name}}&species={{query.species}}&status={{query.status}}&gender={{query.gender}}&location={{query.location}}&origin={{query.origin}}"
          class="pagination-btn"
        >« First</a>
        <a
          href="/characters?page={{subtract currentPage 1}}&name={{query.name}}&species={{query.species}}&status={{query.status}}&gender={{query.gender}}&location={{query.location}}&origin={{query.origin}}"
          class="pagination-btn"
        >‹ Prev</a>
      {{/if}}

      <span class="pagination-info">
        Page {{currentPage}} of {{totalPages}}
      </span>

      {{#if (lt currentPage totalPages)}}
        <a
          href="/characters?page={{add currentPage 1}}&name={{query.name}}&species={{query.species}}&status={{query.status}}&gender={{query.gender}}&location={{query.location}}&origin={{query.origin}}"
          class="pagination-btn"
        >Next ›</a>
        <a
          href="/characters?page={{totalPages}}&name={{query.name}}&species={{query.species}}&status={{query.status}}&gender={{query.gender}}&location={{query.location}}&origin={{query.origin}}"
          class="pagination-btn"
        >Last »</a>
      {{/if}}
    </div>
  {{else}}
    <div class="no-data-container">
      <div class="no-data-content">
        <h2>Wubba Lubba Dub Dub!</h2>
        <p>No characters found...</p>
        <p class="sub-text">Try adjusting your filters or search for someone else.</p>
      </div>
    </div>
  {{/if}}
</div>

<script>
  // Handle card click to expand/collapse CRUD actions
  document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.list-card');
    
    cards.forEach(card => {
      card.addEventListener('click', function(e) {
        // Don't trigger if clicking on a button, link, or form
        if (e.target.closest('a, button, form')) {
          return;
        }
        
        // Close all other cards
        cards.forEach(c => {
          if (c !== card) {
            c.classList.remove('card-expanded');
            const crudActions = c.querySelector('.crud-actions');
            if (crudActions) {
              crudActions.style.display = 'none';
            }
          }
        });
        
        // Toggle this card
        card.classList.toggle('card-expanded');
        const crudActions = card.querySelector('.crud-actions');
        if (crudActions) {
          crudActions.style.display = 
            card.classList.contains('card-expanded') ? 'inline-block' : 'none';
        }
      });
    });
    
    // Close expanded card when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.list-card')) {
        cards.forEach(card => {
          card.classList.remove('card-expanded');
          const crudActions = card.querySelector('.crud-actions');
          if (crudActions) {
            crudActions.style.display = 'none';
          }
        });
      }
    });
  });
</script>
<div class="list-container">
  <div class="list-header-row">
    <h1>{{title}}</h1>
    {{#if session.userId}}
    <a href="/episodes/create" class="btn-create">+ Create New Episode</a>
    {{/if}}
  </div>

  <div class="list-stats">
    <p>Total Episodes: <strong>{{totalEpisodes}}</strong></p>
  </div>

  {{!-- FILTER SECTION --}}
  <div class="filter-section">
    <form method="GET" action="/episodes" class="filter-form">
      <div class="filter-group">
        <label for="season">SEASON</label>
        <select name="season" id="season" class="filter-select">
          <option value="all" {{#if (eq selectedSeason "all" )}}selected{{/if}}>All</option>
          {{#each allSeasons}}
          <option value="{{this}}" {{#if (eq ../selectedSeason this)}}selected{{/if}}>
            {{this}}
          </option>
          {{/each}}
        </select>
      </div>
      <div class="filter-actions">
        <button type="submit" class="filter-apply-btn">Apply</button>
        <a href="/episodes" class="character-filter-clear-btn">Clear</a>
      </div>
    </form>
  </div>

  {{!-- EPISODE CARDS --}}
  <div class="list">
    {{#each episodes}}
    <div class="list-card" data-episode-id="{{this.episodeId}}">
      <div class="list-header">
        <h2>{{this.name}}</h2>
        <span class="list-code">{{this.episode}}</span>
      </div>

      <div class="list-details">
        <p><strong>Air Date:</strong> {{this.air_date}}</p>
        <p><strong>Characters:</strong> {{this.characters.length}}</p>
        <p><strong>Episode ID:</strong> {{this.episodeId}}</p>
      </div>

      <div class="list-actions">
        <!-- VIEW DETAILS ALWAYS VISIBLE -->
        <a href="/episodes/{{this.episodeId}}" class="btn-view">View Details</a>

        <!-- CRUD ACTIONS - HIDDEN BY DEFAULT, ADMIN ONLY -->
        {{#if (eq ../session.role "admin")}}
        <div class="crud-actions" style="display: none;">
          <a href="/episodes/edit/{{this.episodeId}}" class="btn-edit">Edit</a>
          <form action="/episodes/delete/{{this.episodeId}}" method="POST"
            onsubmit="return confirm('Are you sure you want to delete this episode?')" style="display: inline-block;">
            <button type="submit" class="btn-delete">Delete</button>
          </form>
        </div>
        {{/if}}
      </div>
    </div>
    {{/each}}
  </div>
</div>

{{!-- PAGINATION --}}
<div class="pagination-container">
  {{#if (gt currentPage 1)}}
  <a href="/episodes?season={{selectedSeason}}&page=1" class="pagination-btn">« First</a>
  <a href="/episodes?season={{selectedSeason}}&page={{subtract currentPage 1}}" class="pagination-btn">‹ Prev</a>
  {{/if}}

  <span class="pagination-info">
    Page {{currentPage}} of {{totalPages}}
  </span>

  {{#if (lt currentPage totalPages)}}
  <a href="/episodes?season={{selectedSeason}}&page={{add currentPage 1}}" class="pagination-btn">Next ›</a>
  <a href="/episodes?season={{selectedSeason}}&page={{totalPages}}" class="pagination-btn">Last »</a>
  {{/if}}
</div>

{{#if (eq session.role "admin")}}
<script>
  // Handle card click to expand/collapse CRUD actions (Admin only)
  document.addEventListener('DOMContentLoaded', function () {
    const cards = document.querySelectorAll('.list-card');

    cards.forEach(card => {
      card.addEventListener('click', function (e) {
        // Don't trigger if clicking on a button, link, or form
        if (e.target.closest('a, button, form')) {
          return;
        }

        // Close all other cards
        cards.forEach(c => {
          if (c !== card) {
            c.classList.remove('card-expanded');
            const crudActions = c.querySelector('.crud-actions');
            if (crudActions) {
              crudActions.style.display = 'none';
            }
          }
        });

        // Toggle this card
        card.classList.toggle('card-expanded');
        const crudActions = card.querySelector('.crud-actions');
        if (crudActions) {
          crudActions.style.display =
            card.classList.contains('card-expanded') ? 'inline-block' : 'none';
        }
      });
    });

    // Close expanded card when clicking outside
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.list-card')) {
        cards.forEach(card => {
          card.classList.remove('card-expanded');
          const crudActions = card.querySelector('.crud-actions');
          if (crudActions) {
            crudActions.style.display = 'none';
          }
        });
      }
    });
  });
</script>
{{/if}}
<div class="detail-container">
  <div class="detail-header">
    <h1>{{episode.name}}</h1>
    <span class="code-large">{{episode.episode}}</span>
  </div>

  <div class="info">
    <div class="info-row">
      <span class="info-label">Air Date:</span>
      <span class="info-value">{{episode.air_date}}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Episode ID:</span>
      <span class="info-value">{{episode.episodeId}}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Total Characters:</span>
      <span class="info-value">{{episode.characters.length}}</span>
    </div>
  </div>

  <div class="sub-section">
    <h2>Characters in this Episode</h2>
    {{#if characters.length}}

    <!-- Carousel Container -->
    <div class="character-carousel-container" id="characterCarousel">
      <div class="character-grid carousel-page" id="characterGrid">
        {{#each characters}}
        <a href="/characters/{{this.characterId}}" class="character-thumbnail-card" data-character-index="{{@index}}">
          <div class="character-thumbnail-image-wrapper">
            <img src="{{this.image}}" alt="{{this.name}}" class="character-thumbnail-image">
          </div>
          <div class="character-thumbnail-info">
            <h3 class="character-thumbnail-name">{{this.name}}</h3>
            <p class="character-thumbnail-species">{{this.species}}</p>
          </div>
        </a>
        {{/each}}
      </div>

      <!-- Carousel Controls -->
      <div class="carousel-controls">
        <button class="carousel-btn carousel-prev" id="carouselPrev" aria-label="Previous page">
          ‹
        </button>

        <div class="carousel-indicators" id="carouselIndicators">
          <!-- Indicators will be generated by JavaScript -->
        </div>

        <button class="carousel-btn carousel-next" id="carouselNext" aria-label="Next page">
          ›
        </button>
      </div>

      <!-- Page info -->
      <div class="carousel-page-info" id="carouselPageInfo">
        <span id="currentPageDisplay">1</span> / <span id="totalPagesDisplay">1</span>
      </div>
    </div>

    <script>
      (function () {
        const ITEMS_PER_PAGE = 15;
        const cards = document.querySelectorAll('.character-thumbnail-card');
        const totalCards = cards.length;
        const totalPages = Math.ceil(totalCards / ITEMS_PER_PAGE);
        let currentPage = 1;

        const prevBtn = document.getElementById('carouselPrev');
        const nextBtn = document.getElementById('carouselNext');
        const indicatorsContainer = document.getElementById('carouselIndicators');
        const currentPageDisplay = document.getElementById('currentPageDisplay');
        const totalPagesDisplay = document.getElementById('totalPagesDisplay');

        // Initialize
        function init() {
          totalPagesDisplay.textContent = totalPages;
          createIndicators();
          showPage(1);
        }

        // Create page indicators
        function createIndicators() {
          indicatorsContainer.innerHTML = '';
          for (let i = 1; i <= totalPages; i++) {
            const indicator = document.createElement('button');
            indicator.className = 'carousel-indicator';
            indicator.setAttribute('aria-label', `Go to page ${i}`);
            indicator.addEventListener('click', () => showPage(i));
            indicatorsContainer.appendChild(indicator);
          }
        }

        // Show specific page
        function showPage(page) {
          if (page < 1 || page > totalPages) return;

          currentPage = page;
          currentPageDisplay.textContent = currentPage;

          // Hide all cards
          cards.forEach(card => {
            card.style.display = 'none';
          });

          // Show cards for current page
          const startIndex = (page - 1) * ITEMS_PER_PAGE;
          const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalCards);

          for (let i = startIndex; i < endIndex; i++) {
            cards[i].style.display = 'flex';
          }

          // Update indicators
          const indicators = indicatorsContainer.querySelectorAll('.carousel-indicator');
          indicators.forEach((indicator, index) => {
            if (index + 1 === currentPage) {
              indicator.classList.add('active');
            } else {
              indicator.classList.remove('active');
            }
          });

          // Update button states
          prevBtn.disabled = currentPage === 1;
          nextBtn.disabled = currentPage === totalPages;
        }

        // Navigation handlers
        prevBtn.addEventListener('click', () => {
          showPage(currentPage - 1);
        });

        nextBtn.addEventListener('click', () => {
          showPage(currentPage + 1);
        });

        // Initialize carousel
        init();
      })();
    </script>

    {{else}}
    <p>No character data available.</p>
    {{/if}}
  </div>

  <div class="detail-actions">
    <a href="/episodes" class="btn-back">← Back to Episodes</a>
    {{#if (eq session.role 'admin')}}
    <a href="/episodes/edit/{{episode.episodeId}}" class="btn-edit" style="margin-left: 15px;">
      Edit Episode
    </a>
    {{/if}}
  </div>
</div>